---
title: "Diagnostics"
author: "Xiaoya Li"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(MASS)
library(e1071)
library(ROCR)
#library(plotROC)
#library(hmeasure)
library(ggplot2)

source("../code/utils.R")
```


```{r}
all <- read.csv("../data/all.csv")
all <- createGrid(all, 4,4)
featureList <- c("NDAI", "SD", "CORR")
```

```{r}
range(all$x)
range(all$y)
mean(all$label == 0)
```


```{r}
set.seed(12345)
folds1 <- splitMethod1(all)

train1 <- all[folds1[[1]],]
val1 <- all[folds1[[2]],]
test1 <- all[folds1[[3]],]
```


```{r}
ggplot(train1, aes(y = NDAI, fill = as.factor(label))) +
  geom_boxplot() +
  ggtitle("NDAI in original training set")
```


```{r}
ggplot(train1, aes(y = SD, fill = as.factor(label))) +
  geom_boxplot() +
  ggtitle("SD in original training set")
```

```{r}
ggplot(train1, aes(y = CORR, fill = as.factor(label))) +
  geom_boxplot() +
  ggtitle("CORR in original training set")
```


### QDA model with original training data

```{r}
set.seed(12345)
qdaOriginCV <- CVgeneric("QDA", train1, featureList, "label", 5, misclassification)
1-qdaOriginCV
```

```{r}
1 - mean(qdaOriginCV)
```


```{r}
qdaModel <- fitQDA(train1, featureList, "label")
qdaModel
```

### performance on validation set

```{r}
qdaVal <- predict(qdaModel, val1, type="response")
mean(qdaVal$class == val1$label)
```

```{r}
val1$pred <- qdaVal$class
```


```{r}
ggplot(val1, aes(x = x, y = y, color = as.factor(pred))) +
  geom_point(alpha = 0.5) +
  ggtitle("Prediction of QDA model") 
```


```{r}
ggplot(val1, aes(x = x, y = y, color = as.factor(label))) +
  geom_point(alpha = 0.5) +
  ggtitle("Original label") 
```

```{r}
mean(val1$label == 0)
```


### performance on test set

```{r}
mean(test1$label == 0)
```

```{r}
qdaTest <- predict(qdaModel, test1, type="response")
mean(qdaTest$class == test1$label)
```

```{r}
test1$pred <- qdaTest$class
```

```{r}
ggplot(test1, aes(x = x, y = y, color = as.factor(pred))) +
  geom_point(alpha = 0.1) +
  ggtitle("Prediction of QDA model(testset)") 
```

```{r}
ggplot(test1, aes(x = x, y = y, color = as.factor(label))) +
  geom_point(alpha = 0.1) +
  ggtitle("Prediction of QDA model(testset)") 
```


#change to another seed and redo the analysis

```{r}
set.seed(560)
folds2 <- splitMethod1(all)

train2 <- all[folds2[[1]],]
val2 <- all[folds2[[2]],]
test2 <- all[folds2[[3]],]
```


```{r}
qdaModel2 <- fitQDA(train2, featureList, "label")
qdaModel2
```

```{r}
qdaVal2 <- predict(qdaModel2, val2, type="response")
mean(qdaVal2$class == val2$label)
```

```{r}
mean(val2$label == 0)
```


```{r}
val2$pred <- qdaVal2$class
ggplot(val2, aes(x = x, y = y, color = as.factor(pred))) +
  geom_point(alpha = 0.2) +
  ggtitle("Prediction of QDA model(Validation)") 
```

```{r}
ggplot(val2, aes(x = x, y = y, color = as.factor(label))) +
  geom_point(alpha = 0.2) +
  ggtitle("Truth label (Validation)") 
```


```{r}
qdaTest2 <- predict(qdaModel2, test2, type="response")
mean(qdaTest2$class == test2$label)
```

```{r}
mean(test2$label == 0)
```


```{r}
test2$pred <- qdaTest2$class
ggplot(test2, aes(x = x, y = y, color = as.factor(pred))) +
  geom_point(alpha = 0.2) +
  ggtitle("Prediction of QDA model(Test)") 
```

```{r}
ggplot(test2, aes(x = x, y = y, color = as.factor(label))) +
  geom_point(alpha = 0.2) +
  ggtitle("Truth label (Test)") 
```

## Redo Analysis using Split method 2
We train our model on training set that generated by split method 2, but
test on the same val and test set. 

```{r}
set.seed(543)
folds3 <- splitMethod2(all)

train3 <- all[folds3[[1]],]
```

```{r}
set.seed(12345)
qdaOriginCV2 <- CVgeneric("QDA", train3, featureList, "label", 5, misclassification)
1-qdaOriginCV2
1 - mean(qdaOriginCV2)
```

```{r}
qdaModel2 <- fitQDA(train3, featureList, "label")
qdaModel2
```

performance of validation set

```{r}
mean(val2$label == 0)
```


```{r}
qdaVal2 <- predict(qdaModel2, val2, type="response")
mean(qdaVal2$class == val2$label)
```

```{r}
val2$pred_split2 <- qdaVal2$class
ggplot(val2, aes(x = x, y = y, color = as.factor(pred_split2))) +
  geom_point(alpha = 0.2) +
  ggtitle("Prediction of QDA model(Split Method 2)")
```


performance of test set

```{r}
mean(test2$label == 0)
```

```{r}
qdaTest2 <- predict(qdaModel2, test2, type="response")
mean(qdaTest2$class == test2$label)
```

```{r}
test2$pred_split2 <- qdaTest2$class
ggplot(test2, aes(x = x, y = y, color = as.factor(pred_split2))) +
  geom_point(alpha = 0.5) +
  ggtitle("Prediction of QDA model on test set(Split Method 2)")
```


```{r}
set.seed(90)
folds3 <- splitMethod2(all)

train3 <- all[folds3[[1]],]

mean(train3$label == 0)
```



## Try adding new features

```{r}
library(mclust)
```

```{r}
em3class <- Mclust(all[, featureList], G = 3)
summary(em3class)
```

```{r}
all$em_label <- em3class$classification
table(all[,c("label", "em_label")])
```

```{r}
train1 <- all[folds1[[1]],]
val1 <- all[folds1[[2]],]
test1 <- all[folds1[[3]],]
```


```{r}
ggplot(all, aes(y = NDAI, fill = as.factor(label))) +
  geom_boxplot() +
  facet_grid(. ~ em_label)
```

```{r}
ggplot(all, aes(y = SD, fill = as.factor(label))) +
  geom_boxplot() +
  facet_grid(. ~ em_label)
```

```{r}
ggplot(all, aes(y = CORR, fill = as.factor(label))) +
  geom_boxplot() +
  facet_grid(. ~ em_label)
```

fit qda with new feature `em_label`

```{r}
featureListEM3 <- c("NDAI", "SD", "CORR", "em_label")
set.seed(12345)
em3cv <- CVgeneric("QDA", train1, featureListEM3, "label", 5, misclassification)
1-em3cv
```

```{r}
1 - mean(em3cv)
```

```{r}
qdaModel_em3 <- fitQDA(train1, featureListEM3, "label")
qda_em3_test <- predict(qdaModel_em3, test1, type="response")
mean(qda_em3_test$class == test1$label)
```

#### Try EM with 4 classes

```{r}
em4class <- Mclust(all[, featureList], G = 4)
summary(em4class)
```

```{r}
all$em4_label <- em4class$classification
table(all[,c("label", "em4_label")])
```


```{r}
ggplot(all, aes(y = NDAI, fill = as.factor(label))) +
  geom_boxplot() +
  facet_grid(. ~ em4_label)
```

```{r}
ggplot(all, aes(y = SD, fill = as.factor(label))) +
  geom_boxplot() +
  facet_grid(. ~ em4_label)
```

```{r}
ggplot(all, aes(y = CORR, fill = as.factor(label))) +
  geom_boxplot() +
  facet_grid(. ~ em4_label)
```

fit qda with new feature `em4_label`

```{r}
train1 <- all[folds1[[1]],]
val1 <- all[folds1[[2]],]
test1 <- all[folds1[[3]],]
```


```{r}
featureListEM4 <- c("NDAI", "SD", "CORR", "em4_label")
set.seed(12345)
em4cv <- CVgeneric("QDA", train1, featureListEM4, "label", 5, misclassification)
1-em4cv
```

```{r}
1 - mean(em4cv)
```

```{r}
qdaModel_em4 <- fitQDA(train1, featureListEM4, "label")
qda_em4_test <- predict(qdaModel_em4, test1, type="response")
mean(qda_em4_test$class == test1$label)
```

